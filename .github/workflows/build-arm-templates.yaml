name: Compiles Bicep files to ARM templates

on:
  push:
    branches: [main]
    paths:
      # only run if bicep files changed
      - 'infrastructure-templates/**/*.bicep'

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3

      - name: Compile Bicep files
        shell: python
        run: |
          import os
          import shutil
          import subprocess

          git = shutil.which('git')
          az = shutil.which('az')

          from pathlib import Path
          templates_path = Path.cwd() / 'infrastructure-templates'
          modules = []

          print('Compiling bicep files...')          
          for dirpath, dirnames, files in os.walk(templates_path):              
              if not templates_path.samefile(dirpath) and Path(dirpath).parent.samefile(templates_path):
                  modules.append(Path(dirpath))

          for moduleSpec in modules:
              print(f'Check if exists: {moduleSpec}/azuredeploy.json')
              if not (moduleSpec / 'azuredeploy.json').exists():                  
                  (moduleSpec / 'azuredeploy.json').touch()                  
                  subprocess.run([git, 'add', moduleSpec / 'azuredeploy.json'])

          for moduleSpec in modules:
              print(f'Compiling Bicep: {moduleSpec}')              
              subprocess.run([az, 'bicep', 'build', '--file', moduleSpec / 'main.bicep', '--outfile', moduleSpec / 'azuredeploy.json'])

          print('Done')

      - name: Commit changes
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git commit -am "Generated ARM templates"
          git push